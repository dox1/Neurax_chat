<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>منصتي — منصة التواصل الاجتماعي</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root{
    --bg:#0b0f14; --card:#0f1720; --muted:#9aa4ad; --accent:#ff4d88; --success:#10b981; --warning:#f59e0b; --error:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:var(--bg);color:#fff}
  .frame{max-width:460px;margin:8px auto;height:95vh;border-radius:18px;overflow:hidden;background:linear-gradient(180deg,#071127,#081322);box-shadow:0 12px 40px rgba(0,0,0,0.6);display:flex;flex-direction:column;position:relative}
  main{flex:1;overflow:auto;-webkit-overflow-scrolling:touch}
  .center{display:flex;align-items:center;justify-content:center}
  
  /* Splash Screen */
  #splashScreen{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px;text-align:center;gap:20px;background:linear-gradient(135deg, #0f1720, #1e293b)}
  .splash-logo{width:120px;height:120px;border-radius:30px;background:linear-gradient(135deg, #ff4d88, #ff8bb5);display:flex;align-items:center;justify-content:center;margin-bottom:20px}
  .splash-logo i{font-size:50px;color:white}
  .splash-brand{font-size:32px;font-weight:800;background:linear-gradient(90deg, #ff4d88, #ff8bb5);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px}
  .splash-tagline{color:var(--muted);font-size:16px;max-width:300px;line-height:1.5}
  .splash-loader{width:40px;height:40px;border:3px solid rgba(255,255,255,0.1);border-top:3px solid var(--accent);border-radius:50%;animation:spin 1.5s linear infinite;margin-top:30px}
  
  /* login-first */
  #loginScreen{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px;text-align:center;gap:14px}
  .brand{font-size:26px;font-weight:800;margin-bottom:6px;background:linear-gradient(90deg, #ff4d88, #ff8bb5);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .card{background:var(--card);border-radius:14px;padding:14px;margin:12px;box-shadow:0 8px 24px rgba(2,6,23,0.4);width:86%}
  .form{padding:6px 0;display:flex;flex-direction:column;gap:10px}
  input[type="email"],input[type="password"],input[type="text"],input[type="url"]{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;outline:none;transition:border-color 0.2s}
  input:focus{border-color:var(--accent)}
  .small-link{color:var(--muted);font-size:14px;margin-top:6px;cursor:pointer;transition:color 0.2s}
  .small-link:hover{color:#fff}
  .btn{padding:12px 18px;border-radius:12px;border:0;background:var(--accent);color:#fff;font-weight:700;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:8px}
  .btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,77,136,0.3)}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
  .btn.ghost:hover{background:rgba(255,255,255,0.05)}
  .btn.success{background:var(--success)}
  .btn.warning{background:var(--warning)}
  .btn.error{background:var(--error)}
  .muted{color:var(--muted);font-size:13px}
  .app-hidden{display:none}
  .topbar{height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 14px;border-bottom:1px solid rgba(255,255,255,0.03);background:rgba(11,15,20,0.8);backdrop-filter:blur(10px)}
  .title{font-weight:700}
  .content{padding:14px}
  .bottom-nav{height:68px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);display:flex;align-items:center;justify-content:space-around;border-top:1px solid rgba(255,255,255,0.03);position:sticky;bottom:0;background:rgba(11,15,20,0.8);backdrop-filter:blur(10px)}
  .nav-btn{display:flex;flex-direction:column;align-items:center;color:var(--muted);cursor:pointer;transition:all 0.2s;padding:8px 12px;border-radius:10px}
  .nav-btn i{font-size:22px}
  .nav-btn.active{color:var(--accent);transform:scale(1.05);background:rgba(255,77,136,0.1)}
  .nav-btn .badge{position:absolute;top:-5px;right:-5px;background:var(--accent);color:white;border-radius:50%;width:18px;height:18px;font-size:10px;display:flex;align-items:center;justify-content:center}
  .fade-in{animation:fadeIn .28s ease both}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
  .user-card{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);margin:8px 0;transition:background 0.2s}
  .user-card:hover{background:rgba(255,255,255,0.05)}
  .user-left{display:flex;align-items:center;gap:12px}
  .avatar{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#334155,#0f1724);display:flex;align-items:center;justify-content:center;font-weight:700;overflow:hidden}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .small-btn{padding:6px 10px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer;transition:all 0.2s;font-size:12px}
  .small-btn:hover{transform:translateY(-1px)}
  .small-btn.success{background:var(--success)}
  .small-btn.warning{background:var(--warning)}
  .small-btn.error{background:var(--error)}
  .chat-box{height:48vh;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
  .bubble{align-self:flex-start;background:rgba(255,255,255,0.04);padding:8px 12px;border-radius:12px;max-width:80%;position:relative}
  .bubble.me{align-self:flex-end;background:linear-gradient(90deg,var(--accent),#ff8bb5);color:#fff}
  .bubble-time{font-size:10px;color:var(--muted);margin-top:4px;text-align:left}
  .bubble.me .bubble-time{text-align:right}
  .input-row{display:flex;gap:8px;margin-top:8px}
  .input-row input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}
  .loader{width:20px;height:20px;border:2px solid rgba(255,255,255,0.1);border-top:2px solid var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  .search-box{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;margin-bottom:12px}
  .notification{position:fixed;top:10px;right:10px;left:10px;background:var(--card);border-radius:10px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:1000;display:flex;align-items:center;justify-content:space-between;animation:slideIn 0.3s ease}
  @keyframes slideIn{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
  .notification.success{border-left:4px solid var(--success)}
  .notification.error{border-left:4px solid var(--error)}
  .notification.warning{border-left:4px solid var(--warning)}
  .tab-container{display:flex;gap:8px;margin-bottom:12px}
  .tab{flex:1;padding:8px;text-align:center;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer;transition:all 0.2s}
  .tab.active{background:var(--accent);color:#fff}
  .status-dot{width:8px;height:8px;border-radius:50%;background:var(--muted);display:inline-block;margin-right:5px}
  .status-dot.online{background:var(--success)}
  .post-card{background:var(--card);border-radius:14px;padding:14px;margin-bottom:12px;box-shadow:0 8px 24px rgba(2,6,23,0.4)}
  .post-actions{display:flex;gap:15px;margin-top:12px;border-top:1px solid rgba(255,255,255,0.03);padding-top:12px}
  .post-action{display:flex;align-items:center;gap:5px;color:var(--muted);cursor:pointer;transition:all 0.2s;padding:5px 10px;border-radius:8px}
  .post-action:hover{background:rgba(255,255,255,0.05);color:#fff}
  .post-action.active{color:var(--accent)}
  .comments-section{margin-top:12px;border-top:1px solid rgba(255,255,255,0.03);padding-top:12px}
  .comment{display:flex;gap:10px;margin-bottom:10px}
  .comment-avatar{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,#334155,#0f1724);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;overflow:hidden;flex-shrink:0}
  .comment-content{flex:1}
  .comment-text{background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:12px}
  .comment-input{display:flex;gap:8px;margin-top:10px}
  .comment-input input{flex:1;padding:8px 12px;border-radius:20px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;font-size:13px}
  @media(min-width:900px){ .frame{margin:18px auto;height:90vh} }
</style>
</head>
<body>
  <div class="frame">
    <!-- Notification Area -->
    <div id="notificationArea"></div>
    
    <main>
      <!-- Splash Screen -->
      <section id="splashScreen" class="fade-in">
        <div class="splash-logo">
          <i class="fas fa-users"></i>
        </div>
        <div class="splash-brand">منصتي الاجتماعية</div>
        <div class="splash-tagline">منصة التواصل الاجتماعي العربية الأولى للتواصل مع الأصدقاء والعائلة</div>
        <div class="splash-loader"></div>
      </section>

      <!-- Login screen -->
      <section id="loginScreen" class="app-hidden fade-in">
        <div class="brand">منصتي الاجتماعية</div>

        <div class="card">
          <div style="text-align:right;margin-bottom:6px;color:var(--muted)">تسجيل الدخول</div>
          <div class="form">
            <input id="loginEmail" type="email" placeholder="البريد الإلكتروني" autocomplete="username">
            <input id="loginPassword" type="password" placeholder="كلمة المرور" autocomplete="current-password">
            <button id="loginBtn" class="btn"><i class="fas fa-sign-in-alt"></i> دخول</button>
            <div id="loginMsg" class="muted"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
              <div id="openSignup" class="small-link">إنشاء حساب جديد</div>
              <div id="openForgotPassword" class="small-link">نسيت كلمة المرور؟</div>
            </div>
            <div style="margin-top:10px">
              <button id="googleSignBtn" class="btn ghost" style="width:100%"><i class="fab fa-google"></i>&nbsp;دخول بجوجل</button>
            </div>
          </div>
        </div>

        <div class="muted">لن يتم عرض أي شيء في التطبيق إلا بعد تسجيل الدخول</div>
      </section>

      <!-- Signup screen (hidden by default) -->
      <section id="signupScreen" class="app-hidden fade-in">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <div style="color:var(--muted)">إنشاء حساب جديد</div>
            <div><button id="backToLogin" class="btn ghost"><i class="fas fa-arrow-right"></i> عودة</button></div>
          </div>
          <div class="form">
            <input id="suFirstName" type="text" placeholder="الاسم" autocomplete="given-name">
            <input id="suLastName" type="text" placeholder="اللقب" autocomplete="family-name">
            <input id="suEmail" type="email" placeholder="البريد الإلكتروني" autocomplete="email">
            <input id="suPassword" type="password" placeholder="كلمة المرور (6 أحرف على الأقل)" autocomplete="new-password">
            <button id="signupBtn" class="btn"><i class="fas fa-user-plus"></i> انشاء الحساب</button>
            <div id="signupMsg" class="muted"></div>
          </div>
        </div>
      </section>

      <!-- Forgot Password Screen -->
      <section id="forgotPasswordScreen" class="app-hidden fade-in">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <div style="color:var(--muted)">استعادة كلمة المرور</div>
            <div><button id="backToLoginFromForgot" class="btn ghost"><i class="fas fa-arrow-right"></i> عودة</button></div>
          </div>
          <div class="form">
            <div class="muted" style="margin-bottom:10px">أدخل بريدك الإلكتروني وسنرسل لك رابطاً لإعادة تعيين كلمة المرور</div>
            <input id="forgotEmail" type="email" placeholder="البريد الإلكتروني" autocomplete="email">
            <button id="sendResetLinkBtn" class="btn"><i class="fas fa-paper-plane"></i> إرسال رابط الاستعادة</button>
            <div id="forgotMsg" class="muted"></div>
          </div>
        </div>
      </section>

      <!-- App (hidden until auth) -->
      <section id="appScreen" class="app-hidden fade-in">
        <div class="topbar">
          <div class="title" id="currentPageTitle">الأخبار</div>
          <div style="display:flex;align-items:center;gap:10px">
            <div id="userAvatar" style="width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,#374151,#111827);display:flex;align-items:center;justify-content:center;font-weight:700;overflow:hidden"></div>
            <div id="userShort" class="muted"></div>
          </div>
        </div>

        <div class="content">
          <div id="newsView" class="view">
            <div class="card">
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
                <div id="currentUserAvatar" style="width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,#374151,#111827);display:flex;align-items:center;justify-content:center;font-weight:700;overflow:hidden"></div>
                <input type="text" id="postInput" placeholder="ماذا يحدث؟" style="flex:1;padding:10px;border-radius:20px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff">
              </div>
              <button id="postBtn" class="btn" style="width:100%"><i class="fas fa-paper-plane"></i> نشر</button>
            </div>
            <div id="postsContainer" style="margin-top:12px"></div>
          </div>

          <div id="membersView" class="view app-hidden">
            <h3><i class="fas fa-users"></i> الأعضاء</h3>
            <input type="text" id="searchMembers" class="search-box" placeholder="ابحث عن الأعضاء...">
            <div class="tab-container">
              <div class="tab active" data-filter="all">الكل</div>
              <div class="tab" data-filter="friends">الأصدقاء</div>
              <div class="tab" data-filter="online">المتصلين</div>
            </div>
            <div id="membersList" style="margin-top:10px"></div>
          </div>

          <div id="requestsView" class="view app-hidden">
            <h3><i class="fas fa-user-friends"></i> طلبات الصداقة</h3>
            <div class="tab-container">
              <div class="tab active" data-type="received">الواردة</div>
              <div class="tab" data-type="sent">المرسلة</div>
            </div>
            <div id="requestsList" style="margin-top:10px"></div>
          </div>

          <div id="messagesView" class="view app-hidden">
            <h3><i class="fas fa-comments"></i> الرسائل</h3>
            <div id="friendsListForChat" style="margin-top:10px"></div>

            <div id="chatArea" class="app-hidden" style="margin-top:12px">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                <div id="chatWithLabel" style="font-weight:700"></div>
                <div id="chatUserStatus" class="muted"><span class="status-dot"></span> غير متصل</div>
              </div>
              <div class="chat-box" id="chatBox"></div>
              <div class="input-row">
                <input id="chatInput" placeholder="اكتب رسالة...">
                <button id="sendMsgBtn" class="small-btn"><i class="fas fa-paper-plane"></i></button>
              </div>
            </div>
          </div>

          <div id="profileView" class="view app-hidden">
            <h3><i class="fas fa-user"></i> بروفايلي</h3>
            <div style="margin-top:12px;text-align:center">
              <div id="profileAvatar" style="width:120px;height:120px;border-radius:20px;font-size:40px;background:linear-gradient(135deg,#374151,#111827);display:flex;align-items:center;justify-content:center;font-weight:700;margin:0 auto;overflow:hidden"></div>
              <div style="margin-top:12px">
                <div id="profileName" style="font-weight:700;font-size:18px"></div>
                <div id="profileEmail" class="muted"></div>
                <div id="profileStatus" class="muted" style="margin-top:4px"><span class="status-dot online"></span> متصل الآن</div>
              </div>
            </div>

            <div style="margin-top:16px" class="card">
              <label class="muted">تحديث الصورة الشخصية</label>
              <input type="file" id="profileImageUpload" accept="image/*" style="margin-top:8px;width:100%">
              <button id="uploadProfilePicBtn" class="btn" style="margin-top:10px"><i class="fas fa-upload"></i> رفع الصورة</button>
            </div>

            <div style="margin-top:12px">
              <button id="signOutBtn" class="btn ghost"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- bottom nav -->
    <div id="bottomNav" class="bottom-nav app-hidden">
      <div class="nav-btn active" data-view="newsView">
        <i class="fas fa-newspaper"></i>
        <div class="muted">الأخبار</div>
      </div>
      <div class="nav-btn" data-view="membersView">
        <i class="fas fa-users"></i>
        <div class="muted">الأعضاء</div>
        <span id="requestsBadge" class="badge app-hidden">0</span>
      </div>
      <div class="nav-btn" data-view="requestsView">
        <i class="fas fa-user-friends"></i>
        <div class="muted">الطلبات</div>
      </div>
      <div class="nav-btn" data-view="messagesView">
        <i class="fas fa-comments"></i>
        <div class="muted">الرسائل</div>
        <span id="messagesBadge" class="badge app-hidden">0</span>
      </div>
      <div class="nav-btn" data-view="profileView">
        <i class="fas fa-user"></i>
        <div class="muted">بروفايلي</div>
      </div>
    </div>
  </div>

<script>
/* ========== firebase config (v8) ========== */
const firebaseConfig = {
  apiKey: "AIzaSyD-Y5bN79ANAS4CCVn8JcHgCPI3oCp5nas",
  authDomain: "login-a3410.firebaseapp.com",
  projectId: "login-a3410",
  storageBucket: "login-a3410.appspot.com",
  messagingSenderId: "541473325651",
  appId: "1:541473325651:web:e8f4ed7299844644837ca6",
  measurementId: "G-YE90YQXZ71"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* ========== DOM ready ========== */
document.addEventListener('DOMContentLoaded', () => {
  /* App State Management */
  const appState = {
    currentUser: null,
    currentView: 'newsView',
    currentChat: null,
    onlineUsers: new Set(),
    notifications: [],
    unreadMessages: 0,
    pendingRequests: 0
  };

  /* helpers (single, safe names) */
  const get = id => document.getElementById(id);
  const show = el => el && el.classList.remove('app-hidden');
  const hide = el => el && el.classList.add('app-hidden');
  
  /* Notification System */
  function showNotification(message, type = 'info', duration = 5000) {
    const notificationArea = get('notificationArea');
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
      <div>${message}</div>
      <button onclick="this.parentElement.remove()" style="background:none;border:none;color:var(--muted);cursor:pointer">
        <i class="fas fa-times"></i>
      </button>
    `;
    notificationArea.appendChild(notification);
    
    setTimeout(() => {
      if (notification.parentElement) {
        notification.remove();
      }
    }, duration);
  }

  /* Loading States */
  function showLoading(container) {
    container.innerHTML = '<div class="loader"></div>';
  }

  /* Show Splash Screen First */
  setTimeout(() => {
    hide(get('splashScreen'));
    show(get('loginScreen'));
  }, 3000); // Show splash for 3 seconds

  /* bottom nav wiring */
  document.querySelectorAll('.nav-btn').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const view = btn.dataset.view;
      appState.currentView = view;
      
      // Update page title
      const titles = {
        newsView: 'الأخبار',
        membersView: 'الأعضاء',
        requestsView: 'طلبات الصداقة',
        messagesView: 'الرسائل',
        profileView: 'الملف الشخصي'
      };
      get('currentPageTitle').textContent = titles[view] || 'منصتي';
      
      document.querySelectorAll('.view').forEach(v=>v.classList.add('app-hidden'));
      const target = document.getElementById(view);
      if(target) target.classList.remove('app-hidden');
      
      // Reset badges when viewing
      if (view === 'messagesView') {
        appState.unreadMessages = 0;
        updateBadges();
      }
      if (view === 'requestsView') {
        appState.pendingRequests = 0;
        updateBadges();
      }
    });
  });

  /* Tab System */
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const container = this.parentElement;
      container.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      // Trigger refresh based on active tab
      if (container.parentElement.id === 'membersView') {
        loadMembers();
      } else if (container.parentElement.id === 'requestsView') {
        loadRequests();
      }
    });
  });

  /* initial UI state */
  hide(get('signupScreen')); 
  hide(get('appScreen')); 
  hide(get('bottomNav'));
  hide(get('forgotPasswordScreen'));
  show(get('splashScreen')); // Show splash first

  /* form navigation */
  get('openSignup').addEventListener('click', ()=>{ 
    hide(get('loginScreen')); 
    show(get('signupScreen')); 
  });
  
  get('backToLogin').addEventListener('click', ()=>{ 
    hide(get('signupScreen')); 
    show(get('loginScreen')); 
  });
  
  get('openForgotPassword').addEventListener('click', ()=>{ 
    hide(get('loginScreen')); 
    show(get('forgotPasswordScreen')); 
  });
  
  get('backToLoginFromForgot').addEventListener('click', ()=>{ 
    hide(get('forgotPasswordScreen')); 
    show(get('loginScreen')); 
  });

  /* signup */
  get('signupBtn').addEventListener('click', async (e)=>{
    e.preventDefault();
    get('signupMsg').textContent = '';
    const firstName = get('suFirstName').value.trim();
    const lastName = get('suLastName').value.trim();
    const email = get('suEmail').value.trim();
    const password = get('suPassword').value;
    
    if(!firstName || !lastName || !email || !password){ 
      get('signupMsg').textContent = 'عليك ملء كل الحقول'; 
      return; 
    }
    
    if(password.length < 6) {
      get('signupMsg').textContent = 'كلمة المرور يجب أن تكون 6 أحرف على الأقل';
      return;
    }

    try {
      get('signupBtn').innerHTML = '<div class="loader"></div>';
      const uc = await auth.createUserWithEmailAndPassword(email,password);
      const uid = uc.user.uid;
      
      // create user doc
      await db.collection('users').doc(uid).set({
        firstName, 
        lastName, 
        email, 
        photoURL:'', 
        friends:[], 
        requests:[], 
        sentRequests: [],
        status: 'online',
        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      showNotification('تم إنشاء حسابك بنجاح!', 'success');
      get('signupMsg').textContent = 'تم الإنشاء — التحويل آلياً...';
    } catch(err){
      console.error(err);
      let errorMsg = 'خطأ أثناء الإنشاء';
      if (err.code === 'auth/email-already-in-use') {
        errorMsg = 'هذا البريد الإلكتروني مستخدم بالفعل';
      } else if (err.code === 'auth/weak-password') {
        errorMsg = 'كلمة المرور ضعيفة جداً';
      } else if (err.code === 'auth/invalid-email') {
        errorMsg = 'البريد الإلكتروني غير صالح';
      }
      get('signupMsg').textContent = errorMsg;
    } finally {
      get('signupBtn').innerHTML = '<i class="fas fa-user-plus"></i> انشاء الحساب';
    }
  });

  /* login */
  get('loginBtn').addEventListener('click', async (e)=>{
    e.preventDefault();
    get('loginMsg').textContent = '';
    const email = get('loginEmail').value.trim();
    const password = get('loginPassword').value;
    
    if(!email || !password) {
      get('loginMsg').textContent = 'يرجى إدخال البريد الإلكتروني وكلمة المرور';
      return;
    }
    
    try {
      get('loginBtn').innerHTML = '<div class="loader"></div>';
      await auth.signInWithEmailAndPassword(email,password);
    } catch(err){
      console.error(err);
      let errorMsg = 'فشل تسجيل الدخول';
      if (err.code === 'auth/user-not-found') {
        errorMsg = 'لا يوجد حساب مرتبط بهذا البريد الإلكتروني';
      } else if (err.code === 'auth/wrong-password') {
        errorMsg = 'كلمة المرور غير صحيحة';
      } else if (err.code === 'auth/invalid-email') {
        errorMsg = 'البريد الإلكتروني غير صالح';
      }
      get('loginMsg').textContent = errorMsg;
    } finally {
      get('loginBtn').innerHTML = '<i class="fas fa-sign-in-alt"></i> دخول';
    }
  });

  /* Forgot Password */
  get('sendResetLinkBtn').addEventListener('click', async (e)=>{
    e.preventDefault();
    get('forgotMsg').textContent = '';
    const email = get('forgotEmail').value.trim();
    
    if(!email) {
      get('forgotMsg').textContent = 'يرجى إدخال البريد الإلكتروني';
      return;
    }
    
    try {
      get('sendResetLinkBtn').innerHTML = '<div class="loader"></div>';
      await auth.sendPasswordResetEmail(email);
      get('forgotMsg').textContent = 'تم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك الإلكتروني';
      showNotification('تم إرسال رابط إعادة تعيين كلمة المرور', 'success');
      
      // Return to login after 3 seconds
      setTimeout(() => {
        hide(get('forgotPasswordScreen'));
        show(get('loginScreen'));
      }, 3000);
    } catch(err){
      console.error(err);
      let errorMsg = 'فشل إرسال رابط الاستعادة';
      if (err.code === 'auth/user-not-found') {
        errorMsg = 'لا يوجد حساب مرتبط بهذا البريد الإلكتروني';
      } else if (err.code === 'auth/invalid-email') {
        errorMsg = 'البريد الإلكتروني غير صالح';
      }
      get('forgotMsg').textContent = errorMsg;
    } finally {
      get('sendResetLinkBtn').innerHTML = '<i class="fas fa-paper-plane"></i> إرسال رابط الاستعادة';
    }
  });
/* google signin (fixed for all environments) */
get('googleSignBtn').addEventListener('click', async ()=>{
  const provider = new firebase.auth.GoogleAuthProvider();
  provider.addScope('profile');
  provider.addScope('email');
  
  try {
    // Try popup first, fallback to redirect if needed
    if (window.location.protocol === 'https:' || window.location.protocol === 'http:') {
      // Use popup for web environments
      await auth.signInWithPopup(provider);
    } else {
      // Use redirect for other environments (mobile, etc.)
      await auth.signInWithRedirect(provider);
    }
  } catch(err){
    console.error("Google Sign-In:", err);
    let errorMsg = "خطأ أثناء دخول Google";
    
    if (err.code === 'auth/popup-closed-by-user') {
      errorMsg = 'تم إلغاء عملية الدخول';
    } else if (err.code === 'auth/network-request-failed') {
      errorMsg = 'خطأ في الشبكة، يرجى المحاولة مرة أخرى';
    } else if (err.code === 'auth/operation-not-supported-in-this-environment') {
      errorMsg = 'التسجيل بجوجل غير مدعوم في هذه البيئة. يرجى فتح التطبيق عبر خادم ويب (localhost)';
      showNotification(errorMsg, 'error', 10000);
      
      // إضافة تعليمات للمستخدم
      
      get('loginMsg').innerHTML = errorMsg + instructions;
      return;
    } else if (err.code === 'auth/popup-blocked') {
      errorMsg = 'تم حظر نافذة التسجيل. يرجى السماح بالنوافذ المنبثقة لهذا الموقع';
    }
    
    showNotification(errorMsg, 'error');
  }
});

  /* sign out */
  get('signOutBtn').addEventListener('click', async () => {
    if (appState.currentUser) {
      // Update user status to offline
      await db.collection('users').doc(appState.currentUser.uid).update({
        status: 'offline',
        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    auth.signOut();
  });

  /* upload profile picture */
  get('uploadProfilePicBtn').addEventListener('click', async ()=>{
    const file = get('profileImageUpload').files[0];
    if (!file) {
      showNotification('يرجى اختيار صورة أولاً', 'warning');
      return;
    }
    
    const me = auth.currentUser; 
    if(!me) return;
    
    try {
      get('uploadProfilePicBtn').innerHTML = '<div class="loader"></div>';
      
      // Upload image to Firebase Storage
      const storageRef = storage.ref();
      const fileRef = storageRef.child(`profile_pictures/${me.uid}/${file.name}`);
      const snapshot = await fileRef.put(file);
      const downloadURL = await snapshot.ref.getDownloadURL();
      
      // Update user document with new photo URL
      await db.collection('users').doc(me.uid).update({ 
        photoURL: downloadURL 
      });
      
      // Update UI
      updateProfileUI({ ...appState.currentUserData, photoURL: downloadURL });
      showNotification('تم تحديث الصورة الشخصية بنجاح', 'success');
      
    } catch(err){ 
      console.error(err); 
      showNotification('فشل رفع الصورة: ' + err.message, 'error'); 
    } finally {
      get('uploadProfilePicBtn').innerHTML = '<i class="fas fa-upload"></i> رفع الصورة';
      get('profileImageUpload').value = '';
    }
  });

  /* create post */
  get('postBtn').addEventListener('click', async ()=>{
    const text = get('postInput').value.trim();
    if(!text) {
      showNotification('يرجى كتابة محتوى للنشر', 'warning');
      return;
    }
    
    const me = auth.currentUser; 
    if(!me) return;
    
    try {
      get('postBtn').innerHTML = '<div class="loader"></div>';
      
      await db.collection('posts').add({
        userId: me.uid,
        userData: {
          firstName: appState.currentUserData.firstName,
          lastName: appState.currentUserData.lastName,
          photoURL: appState.currentUserData.photoURL
        },
        content: text,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        likes: [],
        comments: []
      });
      
      get('postInput').value = '';
      showNotification('تم نشر منشورك بنجاح', 'success');
      
    } catch(err){ 
      console.error(err); 
      showNotification('فشل نشر المنشور: ' + err.message, 'error'); 
    } finally {
      get('postBtn').innerHTML = '<i class="fas fa-paper-plane"></i> نشر';
    }
  });

  /* send message (realtime) */
  get('sendMsgBtn').addEventListener('click', async ()=>{
    const text = get('chatInput').value.trim();
    if(!text || !appState.currentChat) return;
    
    const me = auth.currentUser; 
    if(!me) return;
    
    try {
      await db.collection('chats').doc(appState.currentChat.id).collection('messages').add({
        senderUid: me.uid,
        senderName: `${appState.currentUserData.firstName} ${appState.currentUserData.lastName}`,
        text, 
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        read: false
      });
      
      get('chatInput').value = '';
      
    } catch(err){ 
      console.error("sendMsg:", err); 
      showNotification('فشل إرسال الرسالة', 'error'); 
    }
  });

  // Allow sending message with Enter key
  get('chatInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      get('sendMsgBtn').click();
    }
  });

  /* ========== Firebase logic & realtime ========== */
  let membersUnsub = null, requestsUnsub = null, friendsUnsub = null, 
      chatUnsub = null, postsUnsub = null, onlineUsersUnsub = null;

  async function ensureNetwork(){ 
    try{ 
      await db.enableNetwork(); 
    } catch(e){ 
      console.warn("enableNetwork:", e.message); 
    } 
  }

  // helper chat id
  function getChatId(a, b){ 
    return a < b ? `${a}_${b}` : `${b}_${a}`; 
  }

  // Update badge counts
  function updateBadges() {
    const requestsBadge = get('requestsBadge');
    const messagesBadge = get('messagesBadge');
    
    if (appState.pendingRequests > 0) {
      requestsBadge.textContent = appState.pendingRequests;
      show(requestsBadge);
    } else {
      hide(requestsBadge);
    }
    
    if (appState.unreadMessages > 0) {
      messagesBadge.textContent = appState.unreadMessages;
      show(messagesBadge);
    } else {
      hide(messagesBadge);
    }
  }

  // open chat with friend: subscribe realtime
  function openChatWith(friendUid, friendName, friendData) {
    show(get('chatArea'));
    get('chatWithLabel').textContent = friendName;
    
    // Update online status
    const statusElement = get('chatUserStatus');
    const statusDot = statusElement.querySelector('.status-dot');
    if (appState.onlineUsers.has(friendUid)) {
      statusDot.className = 'status-dot online';
      statusElement.innerHTML = '<span class="status-dot online"></span> متصل الآن';
    } else {
      statusDot.className = 'status-dot';
      statusElement.innerHTML = '<span class="status-dot"></span> غير متصل';
    }
    
    // switch to messages view
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.querySelector('.nav-btn[data-view="messagesView"]').classList.add('active');
    document.querySelectorAll('.view').forEach(v=>v.classList.add('app-hidden'));
    get('messagesView').classList.remove('app-hidden');

    const me = auth.currentUser; 
    if(!me) return;
    
    const chatId = getChatId(me.uid, friendUid);
    appState.currentChat = { id: chatId, with: friendUid, name: friendName };

    if(chatUnsub) chatUnsub();
    
    const chatRef = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp');
    chatUnsub = chatRef.onSnapshot(snapshot => {
      const chatBox = get('chatBox');
      chatBox.innerHTML = '';
      
      snapshot.forEach(d => {
        const m = d.data();
        const div = document.createElement('div');
        div.className = 'bubble ' + (m.senderUid === me.uid ? 'me' : '');
        
        const time = m.timestamp ? m.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
        div.innerHTML = `
          <div>${m.text}</div>
          <div class="bubble-time">${time}</div>
        `;
        
        chatBox.appendChild(div);
        
        // Mark as read if it's from the other user
        if (m.senderUid !== me.uid && !m.read) {
          d.ref.update({ read: true });
        }
      });
      
      // scroll to bottom
      chatBox.scrollTop = chatBox.scrollHeight;
    }, err => console.error("chat onSnapshot:", err));
  }

  // load friends for chat and render list
  async function loadFriendsForChat(myUid) {
    const myRef = db.collection('users').doc(myUid);
    
    if(friendsUnsub) friendsUnsub();
    
    friendsUnsub = myRef.onSnapshot(async snap => {
      const data = snap.data();
      const friends = data && data.friends ? data.friends : [];
      const container = get('friendsListForChat'); 
      
      showLoading(container);
      
      if(friends.length === 0){ 
        container.innerHTML = '<div class="muted">لا أصدقاء للرسائل بعد</div>'; 
        return; 
      }
      
      const friendsData = await Promise.all(
        friends.map(async fid => {
          try {
            const fdoc = await db.collection('users').doc(fid).get();
            return { id: fid, ...fdoc.data() };
          } catch(e) { 
            console.warn("load friend:", e); 
            return null;
          }
        })
      );
      
      container.innerHTML = '';
      
      friendsData.filter(f => f).forEach(fu => {
        const row = document.createElement('div'); 
        row.className = 'user-card';
        
        const isOnline = appState.onlineUsers.has(fu.id);
        const statusClass = isOnline ? 'online' : '';
        
        row.innerHTML = `
          <div class="user-left">
            <div class="avatar">
              ${fu.photoURL ? `<img src="${fu.photoURL}" alt="${fu.firstName}">` : (fu.firstName ? fu.firstName[0].toUpperCase() : 'U')}
            </div>
            <div>
              <div style="font-weight:700">${fu.firstName||''} ${fu.lastName||''}</div>
              <div class="muted">${fu.email||''}</div>
              <div class="muted"><span class="status-dot ${statusClass}"></span> ${isOnline ? 'متصل الآن' : 'غير متصل'}</div>
            </div>
          </div>
          <div>
            <button class="small-btn">مراسلة</button>
          </div>
        `;
        
        container.appendChild(row);
        row.querySelector('button').onclick = () => openChatWith(fu.id, `${fu.firstName||''} ${fu.lastName||''}`, fu);
      });
    }, err => console.error("friends onSnapshot:", err));
  }

  // send friend request (push my uid into target.requests)
  async function sendFriendRequest(targetUid) {
    const me = auth.currentUser; 
    if(!me) return;
    
    try {
      // Add to target's requests and to my sentRequests
      await db.collection('users').doc(targetUid).update({ 
        requests: firebase.firestore.FieldValue.arrayUnion(me.uid) 
      });
      
      await db.collection('users').doc(me.uid).update({
        sentRequests: firebase.firestore.FieldValue.arrayUnion(targetUid)
      });
      
      showNotification('تم إرسال طلب الصداقة', 'success');
    } catch(err){ 
      console.error(err); 
      showNotification('فشل إرسال الطلب: ' + err.message, 'error'); 
    }
  }

  // respond to request: accept -> add to friends arrays
  async function respondToRequest(fromUid, accept) {
    const me = auth.currentUser; 
    if(!me) return;
    
    try {
      const myRef = db.collection('users').doc(me.uid);
      const fromRef = db.collection('users').doc(fromUid);
      
      if(accept){
        // Remove from requests, add to friends for both users
        await myRef.update({ 
          requests: firebase.firestore.FieldValue.arrayRemove(fromUid), 
          friends: firebase.firestore.FieldValue.arrayUnion(fromUid) 
        });
        
        await fromRef.update({ 
          sentRequests: firebase.firestore.FieldValue.arrayRemove(me.uid),
          friends: firebase.firestore.FieldValue.arrayUnion(me.uid) 
        });
        
        showNotification('تم قبول طلب الصداقة', 'success');
        
        // Create a chat document for the new friends
        const chatId = getChatId(me.uid, fromUid);
        await db.collection('chats').doc(chatId).set({
          participants: [me.uid, fromUid],
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
      } else {
        // Just remove the request
        await myRef.update({ 
          requests: firebase.firestore.FieldValue.arrayRemove(fromUid) 
        });
        
        await fromRef.update({
          sentRequests: firebase.firestore.FieldValue.arrayRemove(me.uid)
        });
        
        showNotification('تم رفض طلب الصداقة', 'info');
      }
    } catch(err){ 
      console.error(err); 
      showNotification('فشل العملية: ' + err.message, 'error'); 
    }
  }

  // cancel sent request
  async function cancelSentRequest(targetUid) {
    const me = auth.currentUser; 
    if(!me) return;
    
    try {
      // Remove from target's requests and from my sentRequests
      await db.collection('users').doc(targetUid).update({ 
        requests: firebase.firestore.FieldValue.arrayRemove(me.uid) 
      });
      
      await db.collection('users').doc(me.uid).update({
        sentRequests: firebase.firestore.FieldValue.arrayRemove(targetUid)
      });
      
      showNotification('تم إلغاء طلب الصداقة', 'info');
    } catch(err){ 
      console.error(err); 
      showNotification('فشل الإلغاء: ' + err.message, 'error'); 
    }
  }

  // load and render posts
  function loadPosts() {
    const container = get('postsContainer');
    
    if(postsUnsub) postsUnsub();
    
    postsUnsub = db.collection('posts')
      .orderBy('timestamp', 'desc')
      .limit(20)
      .onSnapshot(snapshot => {
        container.innerHTML = '';
        
        if(snapshot.empty) {
          container.innerHTML = '<div class="muted" style="text-align:center;padding:20px">لا توجد منشورات بعد</div>';
          return;
        }
        
        snapshot.forEach(doc => {
          const post = doc.data();
          const postElement = document.createElement('div');
          postElement.className = 'post-card';
          
          const time = post.timestamp ? post.timestamp.toDate().toLocaleString('ar-SA') : '';
          const me = auth.currentUser;
          const isLiked = me && post.likes && post.likes.includes(me.uid);
          
          postElement.innerHTML = `
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
              <div class="avatar" style="width:40px;height:40px">
                ${post.userData.photoURL ? 
                  `<img src="${post.userData.photoURL}" alt="${post.userData.firstName}">` : 
                  (post.userData.firstName ? post.userData.firstName[0].toUpperCase() : 'U')}
              </div>
              <div>
                <div style="font-weight:700">${post.userData.firstName} ${post.userData.lastName}</div>
                <div class="muted" style="font-size:12px">${time}</div>
              </div>
            </div>
            <div style="margin:10px 0">${post.content}</div>
            <div class="post-actions">
              <div class="post-action ${isLiked ? 'active' : ''}" data-action="like" data-post="${doc.id}">
                <i class="fas fa-heart"></i> 
                <span>${post.likes ? post.likes.length : 0}</span>
              </div>
              <div class="post-action" data-action="comment" data-post="${doc.id}">
                <i class="fas fa-comment"></i> 
                <span>${post.comments ? post.comments.length : 0}</span>
              </div>
            </div>
            <div class="comments-section app-hidden" id="comments-${doc.id}">
              <div class="comment-input">
                <input type="text" placeholder="اكتب تعليق..." id="comment-input-${doc.id}">
                <button class="small-btn" data-post="${doc.id}"><i class="fas fa-paper-plane"></i></button>
              </div>
              <div id="comments-list-${doc.id}"></div>
            </div>
          `;
          
          container.appendChild(postElement);
          
          // Add like functionality
          const likeBtn = postElement.querySelector('[data-action="like"]');
          likeBtn.addEventListener('click', async () => {
            if (!me) return;
            
            try {
              const postRef = db.collection('posts').doc(doc.id);
              const postDoc = await postRef.get();
              const currentLikes = postDoc.data().likes || [];
              
              if (currentLikes.includes(me.uid)) {
                // Unlike
                await postRef.update({
                  likes: firebase.firestore.FieldValue.arrayRemove(me.uid)
                });
              } else {
                // Like
                await postRef.update({
                  likes: firebase.firestore.FieldValue.arrayUnion(me.uid)
                });
              }
            } catch (err) {
              console.error("Error liking post:", err);
            }
          });
          
          // Add comment functionality
          const commentBtn = postElement.querySelector('[data-action="comment"]');
          const commentsSection = postElement.querySelector('.comments-section');
          const commentInput = postElement.querySelector(`#comment-input-${doc.id}`);
          const commentSendBtn = postElement.querySelector(`[data-post="${doc.id}"]`);
          
          commentBtn.addEventListener('click', () => {
            commentsSection.classList.toggle('app-hidden');
          });
          
          commentSendBtn.addEventListener('click', async () => {
            const commentText = commentInput.value.trim();
            if (!commentText || !me) return;
            
            try {
              const comment = {
                userId: me.uid,
                userData: {
                  firstName: appState.currentUserData.firstName,
                  lastName: appState.currentUserData.lastName,
                  photoURL: appState.currentUserData.photoURL
                },
                text: commentText,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              await db.collection('posts').doc(doc.id).update({
                comments: firebase.firestore.FieldValue.arrayUnion(comment)
              });
              
              commentInput.value = '';
              showNotification('تم إضافة تعليقك', 'success');
            } catch (err) {
              console.error("Error adding comment:", err);
              showNotification('فشل إضافة التعليق', 'error');
            }
          });
          
          // Load existing comments
          if (post.comments && post.comments.length > 0) {
            const commentsList = postElement.querySelector(`#comments-list-${doc.id}`);
            commentsList.innerHTML = '';
            
            post.comments.forEach(comment => {
              const commentElement = document.createElement('div');
              commentElement.className = 'comment';
              
              commentElement.innerHTML = `
                <div class="comment-avatar">
                  ${comment.userData.photoURL ? 
                    `<img src="${comment.userData.photoURL}" alt="${comment.userData.firstName}">` : 
                    (comment.userData.firstName ? comment.userData.firstName[0].toUpperCase() : 'U')}
                </div>
                <div class="comment-content">
                  <div style="font-weight:700;font-size:13px">${comment.userData.firstName} ${comment.userData.lastName}</div>
                  <div class="comment-text">${comment.text}</div>
                </div>
              `;
              
              commentsList.appendChild(commentElement);
            });
          }
        });
      }, err => console.error("posts onSnapshot:", err));
  }

  // render members list with correct buttons (Add / Accept / Message)
  async function loadMembers() {
    const me = auth.currentUser;
    if (!me) return;
    
    const container = get('membersList');
    const searchTerm = get('searchMembers').value.toLowerCase();
    const activeFilter = document.querySelector('#membersView .tab.active').dataset.filter;
    
    if(membersUnsub) membersUnsub();
    
    membersUnsub = db.collection('users').onSnapshot(async snap => {
      showLoading(container);
      
      const myDoc = await db.collection('users').doc(me.uid).get();
      const myData = myDoc.data();
      
      const members = [];
      
      snap.forEach(doc => {
        if (doc.id !== me.uid) {
          members.push({ id: doc.id, ...doc.data() });
        }
      });
      
      // Apply filters
      let filteredMembers = members;
      
      if (searchTerm) {
        filteredMembers = filteredMembers.filter(m => 
          `${m.firstName} ${m.lastName}`.toLowerCase().includes(searchTerm) || 
          m.email.toLowerCase().includes(searchTerm)
        );
      }
      
      if (activeFilter === 'friends') {
        filteredMembers = filteredMembers.filter(m => 
          myData.friends && myData.friends.includes(m.id)
        );
      } else if (activeFilter === 'online') {
        filteredMembers = filteredMembers.filter(m => 
          appState.onlineUsers.has(m.id)
        );
      }
      
      container.innerHTML = '';
      
      if(filteredMembers.length === 0){ 
        container.innerHTML = '<div class="muted" style="text-align:center;padding:20px">لا يوجد أعضاء</div>'; 
        return; 
      }
      
      for(const member of filteredMembers){
        const u = member;
        const row = document.createElement('div'); 
        row.className = 'user-card';
        
        const isFriend = myData.friends && myData.friends.includes(u.id);
        const targetHasRequestFromMe = myData.sentRequests && myData.sentRequests.includes(u.id);
        const iHaveRequestFromThem = myData.requests && myData.requests.includes(u.id);
        const isOnline = appState.onlineUsers.has(u.id);
        const statusClass = isOnline ? 'online' : '';
        
        row.innerHTML = `
          <div class="user-left">
            <div class="avatar">
              ${u.photoURL ? `<img src="${u.photoURL}" alt="${u.firstName}">` : (u.firstName ? u.firstName[0].toUpperCase() : 'U')}
            </div>
            <div>
              <div style="font-weight:700">${u.firstName||''} ${u.lastName||''}</div>
              <div class="muted">${u.email||''}</div>
              <div class="muted"><span class="status-dot ${statusClass}"></span> ${isOnline ? 'متصل الآن' : 'غير متصل'}</div>
            </div>
          </div>
          <div id="btn-${u.id}"></div>
        `;
        
        container.appendChild(row);
        
        const holder = get('btn-'+u.id);
        
        if(isFriend){
          const btn = document.createElement('button'); 
          btn.className='small-btn'; 
          btn.innerHTML = '<i class="fas fa-comment"></i> مراسلة';
          btn.onclick = () => openChatWith(u.id, `${u.firstName||''} ${u.lastName||''}`, u);
          holder.appendChild(btn);
        } else if(iHaveRequestFromThem){
          const acc = document.createElement('button'); 
          acc.className='small-btn success'; 
          acc.innerHTML = '<i class="fas fa-check"></i> قبول';
          const rej = document.createElement('button'); 
          rej.className='small-btn error'; 
          rej.style.marginLeft='8px'; 
          rej.innerHTML = '<i class="fas fa-times"></i> رفض';
          acc.onclick = () => respondToRequest(u.id, true);
          rej.onclick = () => respondToRequest(u.id, false);
          holder.appendChild(acc); 
          holder.appendChild(rej);
        } else if(targetHasRequestFromMe){
          const span = document.createElement('div'); 
          span.className='muted'; 
          span.innerHTML = '<i class="fas fa-clock"></i> تم إرسال طلب';
          const cancelBtn = document.createElement('button');
          cancelBtn.className = 'small-btn error';
          cancelBtn.style.marginTop = '5px';
          cancelBtn.innerHTML = '<i class="fas fa-times"></i> إلغاء';
          cancelBtn.onclick = () => cancelSentRequest(u.id);
          holder.appendChild(span);
          holder.appendChild(cancelBtn);
        } else {
          const add = document.createElement('button'); 
          add.className='small-btn'; 
          add.innerHTML = '<i class="fas fa-user-plus"></i> إضافة';
          add.onclick = () => sendFriendRequest(u.id);
          holder.appendChild(add);
        }
      }
    }, err => console.error("members snapshot:", err));
  }

  // render incoming requests list (requestsView)
  async function loadRequests() {
    const me = auth.currentUser;
    if (!me) return;
    
    const container = get('requestsList');
    const activeTab = document.querySelector('#requestsView .tab.active').dataset.type;
    
    if(requestsUnsub) requestsUnsub();
    
    requestsUnsub = db.collection('users').doc(me.uid).onSnapshot(async d => {
      const data = d.data();
      
      if (!data) {
        container.innerHTML = '<div class="muted">جاري التحميل...</div>';
        return;
      }
      
      showLoading(container);
      
      if(activeTab === 'received') {
        // Received requests
        const requests = data.requests || [];
        
        if(requests.length === 0){ 
          container.innerHTML = '<div class="muted" style="text-align:center;padding:20px">لا توجد طلبات واردة</div>'; 
          return; 
        }
        
        container.innerHTML = '';
        
        for(const uid of requests){
          try {
            const uDoc = await db.collection('users').doc(uid).get();
            const u = uDoc.data();
            const div = document.createElement('div'); 
            div.className='user-card';
            
            div.innerHTML = `
              <div class="user-left">
                <div class="avatar">
                  ${u.photoURL ? `<img src="${u.photoURL}" alt="${u.firstName}">` : (u.firstName ? u.firstName[0].toUpperCase() : 'U')}
                </div>
                <div>
                  <div style="font-weight:700">${u.firstName||''} ${u.lastName||''}</div>
                  <div class="muted">${u.email||''}</div>
                </div>
              </div>
              <div>
                <button class="small-btn success" id="acc-${uid}"><i class="fas fa-check"></i> قبول</button>
                <button class="small-btn error" id="rej-${uid}" style="margin-left:8px"><i class="fas fa-times"></i> رفض</button>
              </div>
            `;
            
            container.appendChild(div);
            get('acc-'+uid).onclick = () => respondToRequest(uid, true);
            get('rej-'+uid).onclick = () => respondToRequest(uid, false);
          } catch(e){ console.warn("renderRequests:", e); }
        }
      } else {
        // Sent requests
        const sentRequests = data.sentRequests || [];
        
        if(sentRequests.length === 0){ 
          container.innerHTML = '<div class="muted" style="text-align:center;padding:20px">لا توجد طلبات مرسلة</div>'; 
          return; 
        }
        
        container.innerHTML = '';
        
        for(const uid of sentRequests){
          try {
            const uDoc = await db.collection('users').doc(uid).get();
            const u = uDoc.data();
            const div = document.createElement('div'); 
            div.className='user-card';
            
            div.innerHTML = `
              <div class="user-left">
                <div class="avatar">
                  ${u.photoURL ? `<img src="${u.photoURL}" alt="${u.firstName}">` : (u.firstName ? u.firstName[0].toUpperCase() : 'U')}
                </div>
                <div>
                  <div style="font-weight:700">${u.firstName||''} ${u.lastName||''}</div>
                  <div class="muted">${u.email||''}</div>
                </div>
              </div>
              <div>
                <button class="small-btn error" id="cancel-${uid}"><i class="fas fa-times"></i> إلغاء</button>
              </div>
            `;
            
            container.appendChild(div);
            get('cancel-'+uid).onclick = () => cancelSentRequest(uid);
          } catch(e){ console.warn("renderSentRequests:", e); }
        }
      }
    }, err => console.error("requests snapshot:", err));
  }

  // Track online users
  function trackOnlineUsers() {
    if(onlineUsersUnsub) onlineUsersUnsub();
    
    onlineUsersUnsub = db.collection('users').where('status', '==', 'online').onSnapshot(snapshot => {
      appState.onlineUsers.clear();
      snapshot.forEach(doc => {
        appState.onlineUsers.add(doc.id);
      });
      
      // Refresh views that show online status
      if (appState.currentView === 'membersView') {
        loadMembers();
      }
      if (appState.currentView === 'messagesView') {
        loadFriendsForChat(appState.currentUser.uid);
      }
    }, err => console.error("online users snapshot:", err));
  }

  // Search functionality
  get('searchMembers').addEventListener('input', () => {
    loadMembers();
  });

  /* update profile UI */
  function updateProfileUI(data) {
    get('userShort').textContent = (data.firstName||'') + ' ' + (data.lastName||'');
    
    // User avatar in top bar
    const userAvatar = get('userAvatar');
    if(data.photoURL){
      userAvatar.innerHTML = `<img src="${data.photoURL}" alt="${data.firstName}">`;
    } else {
      userAvatar.textContent = data.firstName ? data.firstName[0].toUpperCase() : 'U';
      userAvatar.style.background = 'linear-gradient(135deg,#374151,#111827)';
    }
    
    // Current user avatar in news feed
    const currentUserAvatar = get('currentUserAvatar');
    if(data.photoURL){
      currentUserAvatar.innerHTML = `<img src="${data.photoURL}" alt="${data.firstName}">`;
    } else {
      currentUserAvatar.textContent = data.firstName ? data.firstName[0].toUpperCase() : 'U';
      currentUserAvatar.style.background = 'linear-gradient(135deg,#374151,#111827)';
    }
    
    // Profile page
    const profileAvatar = get('profileAvatar');
    if(data.photoURL){
      profileAvatar.innerHTML = `<img src="${data.photoURL}" alt="${data.firstName}">`;
    } else {
      profileAvatar.textContent = data.firstName ? data.firstName[0].toUpperCase() : 'U';
      profileAvatar.style.background = 'linear-gradient(135deg,#374151,#111827)';
    }
    
    get('profileName').textContent = (data.firstName||'') + ' ' + (data.lastName||'');
    get('profileEmail').textContent = data.email || '';
  }

  // network + auth state
  auth.onAuthStateChanged(async user => {
    await ensureNetwork();
    
    if(user){
      try{ 
        await user.reload(); 
      } catch(e){ 
        console.warn("reload:", e.message); 
      }
      
      // Update user status to online
      await db.collection('users').doc(user.uid).update({
        status: 'online',
        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // ensure user doc exists
      const docRef = db.collection('users').doc(user.uid);
      let doc;
      
      try { 
        doc = await docRef.get(); 
      } catch(err){ 
        console.error("get user doc:", err.message); 
        showNotification("تعذر الاتصال بقاعدة البيانات — تأكد من إعدادات Firestore وقواعده.", 'error'); 
        auth.signOut(); 
        return; 
      }

      if(!doc.exists){
        await docRef.set({
          firstName: user.displayName ? user.displayName.split(' ')[0] : 'مستخدم',
          lastName: user.displayName ? (user.displayName.split(' ')[1]||'') : '',
          email: user.email || '', 
          photoURL: user.photoURL || '', 
          friends:[], 
          requests:[],
          sentRequests: [],
          status: 'online',
          lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        doc = await docRef.get();
      }

      appState.currentUser = user;
      appState.currentUserData = doc.data();
      
      updateProfileUI(appState.currentUserData);

      // show app
      hide(get('loginScreen')); 
      hide(get('signupScreen')); 
      hide(get('forgotPasswordScreen'));
      show(get('appScreen')); 
      show(get('bottomNav'));

      // Start tracking online users
      trackOnlineUsers();
      
      // Load initial data
      loadPosts();
      loadMembers();
      loadRequests();
      loadFriendsForChat(user.uid);

      // Check for pending requests
      const requests = appState.currentUserData.requests || [];
      appState.pendingRequests = requests.length;
      updateBadges();

    } else {
      // logged out: cleanup
      if(membersUnsub) membersUnsub(); membersUnsub=null;
      if(requestsUnsub) requestsUnsub(); requestsUnsub=null;
      if(friendsUnsub) friendsUnsub(); friendsUnsub=null;
      if(chatUnsub) chatUnsub(); chatUnsub=null;
      if(postsUnsub) postsUnsub(); postsUnsub=null;
      if(onlineUsersUnsub) onlineUsersUnsub(); onlineUsersUnsub=null;
      
      appState.currentChat = null;
      appState.currentUserData = null;
      appState.onlineUsers.clear();
      
      // reset UI to login
      hide(get('appScreen')); 
      hide(get('bottomNav')); 
      show(get('loginScreen'));
      
      // reset views
      document.querySelectorAll('.view').forEach(v=>v.classList.add('app-hidden'));
      get('newsView').classList.remove('app-hidden');
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
      document.querySelector('.nav-btn')?.classList.add('active');
      
      // Reset form fields
      get('loginEmail').value = '';
      get('loginPassword').value = '';
      get('suFirstName').value = '';
      get('suLastName').value = '';
      get('suEmail').value = '';
      get('suPassword').value = '';
      get('forgotEmail').value = '';
    }
  });

}); // end DOMContentLoaded
</script>
</body>
</html>