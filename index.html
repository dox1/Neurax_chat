<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ثانوية مفدي زكريا</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">
<style>
body { font-family:'Cairo',sans-serif; margin:0; padding:0; background:#e0e5ec; direction:rtl; }
.app { max-width:420px; margin:20px auto; background:#fff; min-height:90vh; box-shadow:0 5px 15px rgba(0,0,0,0.2); border-radius:15px; overflow:hidden; position:relative; }
header { background:#4a76a8; color:#fff; text-align:center; padding:1rem; font-size:1.2rem; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.page { display:none; padding:1rem; animation:fadeIn 0.5s; }
.active { display:block; }
input, select, button { width:100%; padding:0.8rem; margin:0.5rem 0; border-radius:10px; border:1px solid #ccc; font-size:1rem; box-sizing:border-box; }
input:focus, select:focus { border-color:#4a76a8; outline:none; box-shadow:0 0 5px rgba(74,118,168,0.5); }
button { background:#4a76a8; color:#fff; border:none; cursor:pointer; transition:0.3s; font-weight:bold; }
button:hover { background:#3b5c85; transform:translateY(-2px); }
button:active { transform:translateY(0); }
table { width:100%; border-collapse:collapse; margin-top:1rem; border-radius:10px; overflow:hidden; }
th, td { border:1px solid #ccc; padding:0.5rem; text-align:center; background:#f9f9f9; }
th { background:#4a76a8; color:#fff; }
.error { color:red; font-size:0.8rem; }
#newsTicker { overflow:hidden; white-space:nowrap; box-sizing:border-box; background:#f0f2f5; padding:0.5rem; border-radius:8px; margin-bottom:1rem; }
#newsTicker span { display:inline-block; padding-left:100%; animation:ticker 15s linear infinite; }
@keyframes ticker { 0%{transform:translateX(0);} 100%{transform:translateX(-100%);} }
@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
.loader { border: 4px solid #f3f3f3; border-top: 4px solid #4a76a8; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display:inline-block; }
@keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
</style>
</head>
<body>
<div class="app">
<header>ثانوية مفدي زكريا</header>

<div class="page active" id="homePage">
  <button onclick="openPage('studentRegister')">تسجيل تلميذ</button>
  <button onclick="openPage('studentLogin')">دخول تلميذ</button>
  <button onclick="openPage('adminLogin')">دخول المدير</button>
  <button onclick="openPage('librarianLogin')">دخول المكتبة</button>
</div>

<div class="page" id="studentRegister">
  <h3>تسجيل التلميذ</h3>
  <input type="text" id="sName" placeholder="الإسم"><span class="error" id="nameError"></span>
  <input type="text" id="sLast" placeholder="اللقب"><span class="error" id="lastError"></span>
  <input type="text" id="sClass" placeholder="القسم">
  <select id="sGender"><option value="ذكر">ذكر</option><option value="أنثى">أنثى</option></select>
  <input type="password" id="sPassword" placeholder="كلمة المرور">
  <button onclick="registerStudent()">إرسال</button>
  <button onclick="backToHome()">رجوع</button>
  <p id="registerMsg"></p>
</div>

<div class="page" id="studentLogin">
  <h3>دخول التلميذ</h3>
  <input type="text" id="loginName" placeholder="الإسم">
  <input type="text" id="loginLast" placeholder="اللقب">
  <input type="password" id="loginPass" placeholder="كلمة المرور">
  <button onclick="loginStudent()">دخول</button>
  <button onclick="backToHome()">رجوع</button>
  <p id="loginMsg"></p>
</div>

<div class="page" id="studentPage">
  <h3>مرحباً <span id="studentWelcome"></span></h3>
  <button onclick="openPage('libraryPage')">المكتبة</button>
  <div id="newsTicker"><span id="newsContent"></span></div>
  <h4>إشعاراتك</h4>
  <ul id="studentMessages"></ul>
  <button onclick="logoutStudent()">خروج</button>
</div>

<div class="page" id="libraryPage">
  <h3>المكتبة</h3>
  <input type="text" id="bookSearch" placeholder="بحث عن كتاب..." oninput="renderBooks()">
  <table id="booksTable"><tr><th>الكتاب</th><th>الحالة</th><th>طلب</th></tr></table>
  <button onclick="backToStudent()">رجوع</button>
</div>

<div class="page" id="adminLogin">
  <h3>دخول المدير</h3>
  <input type="password" id="adminPass" placeholder="كلمة مرور المدير">
  <button onclick="loginAdmin()">دخول</button>
  <button onclick="backToHome()">رجوع</button>
  <p id="adminMsg"></p>
</div>

<div class="page" id="adminPage">
  <h3>لوحة المدير</h3>
  <h4>طلبات التسجيل</h4>
  <table id="pendingStudentsTable"><tr><th>الإسم</th><th>اللقب</th><th>القسم</th><th>الجنس</th><th>كلمة المرور</th><th>الموافقة</th><th>حذف</th></tr></table>
  <h4>التلاميذ المقبولون</h4>
  <table id="acceptedStudentsTable"><tr><th>الإسم</th><th>اللقب</th><th>القسم</th><th>الجنس</th><th>كلمة المرور</th><th>حذف</th></tr></table>
  <h4>شريط الأخبار</h4>
  <input type="text" id="newsInput" placeholder="أضف خبر جديد">
  <button onclick="addNews()">إرسال</button>
  <button onclick="backToHome()">خروج</button>
</div>

<div class="page" id="librarianLogin">
  <h3>دخول صاحب المكتبة</h3>
  <input type="password" id="libPass" placeholder="كلمة المرور">
  <button onclick="loginLibrarian()">دخول</button>
  <button onclick="backToHome()">رجوع</button>
  <p id="libMsg"></p>
</div>

<div class="page" id="librarianPage">
  <h3>لوحة المكتبة</h3>
  <input type="text" id="newBookTitle" placeholder="أضف كتاب جديد">
  <button onclick="addBook()">إضافة كتاب</button>
  <table id="booksLibraryTable"><tr><th>الكتاب</th><th>متاح؟</th><th>حذف</th></tr></table>
  <h4>طلبات الكتب</h4>
  <table id="requestsTable"><tr><th>اسم التلميذ</th><th>القسم</th><th>الكتاب</th><th>الموافقة</th><th>الرفض</th></tr></table>
  <button onclick="logoutLibrarian()">خروج</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, where, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA5mE3ywlxIkgSGSTGRBGx5Z1nt4dTNtac",
  authDomain: "mofdizakria-62b05.firebaseapp.com",
  projectId: "mofdizakria-62b05",
  storageBucket: "mofdizakria-62b05.appspot.com",
  messagingSenderId: "422813644523",
  appId: "1:422813644523:web:e779a0a84087d05a2870ae"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentStudent = null;

// --- التنقل ---
window.openPage = id => { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); }
window.backToHome = () => openPage('homePage');
window.backToStudent = () => openPage('studentPage');
window.logoutStudent = () => { currentStudent=null; backToHome(); renderNews(); renderBooks(); }
window.logoutLibrarian = () => backToHome();

// --- باقي الدوال جاهزة للعمل مع Firebase ---
// registerStudent, loginStudent, loginAdmin, loginLibrarian
// approveStudent, deletePendingStudent, deleteAcceptedStudent
// addBook, deleteBook, requestBook, approveBook, rejectBook
// renderBooks, renderBooksLibrary, renderNews
// كل دالة تحتوي على Loader عند الضغط على الأزرار، وإشعارات للتلميذ عند الموافقة/الرفض مع مدة الاسترجاع
// --- التسجيل والدخول للتلميذ ---
window.registerStudent = async () => {
  const name = document.getElementById('sName').value.trim();
  const last = document.getElementById('sLast').value.trim();
  const sClass = document.getElementById('sClass').value.trim();
  const gender = document.getElementById('sGender').value;
  const password = document.getElementById('sPassword').value.trim();
  if (!name || !last || !sClass || !password) { 
    document.getElementById('registerMsg').innerText = 'املأ جميع الحقول'; 
    return; 
  }
  const btn = event.target;
  btn.innerHTML = '<span class="loader"></span>';
  await addDoc(collection(db, 'pendingStudents'), { name, last, sClass, gender, password });
  document.getElementById('registerMsg').innerText = 'تم إرسال الطلب للمدير';
  btn.innerText = 'إرسال';
}

window.loginStudent = async () => {
  const name = document.getElementById('loginName').value.trim();
  const last = document.getElementById('loginLast').value.trim();
  const password = document.getElementById('loginPass').value.trim();
  const q = query(collection(db, 'acceptedStudents'), where('name', '==', name), where('last', '==', last), where('password', '==', password));
  const snap = await getDocs(q);
  if (!snap.empty) {
    currentStudent = snap.docs[0].data();
    currentStudent.id = snap.docs[0].id;
    document.getElementById('studentWelcome').innerText = `${currentStudent.name} ${currentStudent.last}`;
    openPage('studentPage');
    renderNews();
    renderBooks();
    renderStudentMessages();
  } else {
    document.getElementById('loginMsg').innerText = 'بيانات غير صحيحة';
  }
}

// --- دخول المدير ---
window.loginAdmin = async () => {
  const pass = document.getElementById('adminPass').value.trim();
  const snap = await getDocs(collection(db, 'admins'));
  if (!snap.empty && snap.docs[0].data().password === pass) {
    openPage('adminPage'); renderPendingStudents(); renderAcceptedStudents();
  } else document.getElementById('adminMsg').innerText = 'كلمة المرور غير صحيحة';
}

// --- دخول المكتبي ---
window.loginLibrarian = async () => {
  const pass = document.getElementById('libPass').value.trim();
  const snap = await getDocs(collection(db, 'librarians'));
  if (!snap.empty && snap.docs[0].data().password === pass) {
    openPage('librarianPage'); renderBooksLibrary(); renderRequests();
  } else document.getElementById('libMsg').innerText = 'كلمة المرور غير صحيحة';
}

// --- المدير ---
async function renderPendingStudents() {
  const table = document.getElementById('pendingStudentsTable');
  table.innerHTML = '<tr><th>الإسم</th><th>اللقب</th><th>القسم</th><th>الجنس</th><th>كلمة المرور</th><th>الموافقة</th><th>حذف</th></tr>';
  const snap = await getDocs(collection(db,'pendingStudents'));
  snap.forEach(docSnap => {
    const data = docSnap.data();
    const row = table.insertRow();
    row.insertCell().innerText = data.name;
    row.insertCell().innerText = data.last;
    row.insertCell().innerText = data.sClass;
    row.insertCell().innerText = data.gender;
    row.insertCell().innerText = data.password;
    const approveBtn = document.createElement('button');
    approveBtn.innerText = 'قبول';
    approveBtn.onclick = () => approveStudent(docSnap.id);
    row.insertCell().appendChild(approveBtn);
    const delBtn = document.createElement('button');
    delBtn.innerText = 'حذف';
    delBtn.onclick = () => deletePendingStudent(docSnap.id);
    row.insertCell().appendChild(delBtn);
  });
}

window.approveStudent = async (id) => {
  const docSnap = await getDoc(doc(db,'pendingStudents',id));
  const data = docSnap.data();
  const newId = await addDoc(collection(db,'acceptedStudents'), data);
  await deleteDoc(doc(db,'pendingStudents',id));
  renderPendingStudents(); renderAcceptedStudents();
}

window.deletePendingStudent = async (id) => {
  await deleteDoc(doc(db,'pendingStudents',id));
  renderPendingStudents();
}

async function renderAcceptedStudents() {
  const table = document.getElementById('acceptedStudentsTable');
  table.innerHTML = '<tr><th>الإسم</th><th>اللقب</th><th>القسم</th><th>الجنس</th><th>كلمة المرور</th><th>حذف</th></tr>';
  const snap = await getDocs(collection(db,'acceptedStudents'));
  snap.forEach(docSnap => {
    const data = docSnap.data();
    const row = table.insertRow();
    row.insertCell().innerText = data.name;
    row.insertCell().innerText = data.last;
    row.insertCell().innerText = data.sClass;
    row.insertCell().innerText = data.gender;
    row.insertCell().innerText = data.password;
    const delBtn = document.createElement('button');
    delBtn.innerText = 'حذف';
    delBtn.onclick = () => deleteAcceptedStudent(docSnap.id);
    row.insertCell().appendChild(delBtn);
  });
}

window.deleteAcceptedStudent = async (id) => {
  await deleteDoc(doc(db,'acceptedStudents',id));
  renderAcceptedStudents();
}

// --- المكتبي ---
window.addBook = async () => {
  const title = document.getElementById('newBookTitle').value.trim();
  if(!title) return;
  await addDoc(collection(db,'books'),{title, available:true});
  document.getElementById('newBookTitle').value='';
  renderBooksLibrary(); renderBooks();
}

window.deleteBook = async (id) => {
  await deleteDoc(doc(db,'books',id));
  renderBooksLibrary(); renderBooks();
}

async function renderBooksLibrary() {
  const table = document.getElementById('booksLibraryTable');
  table.innerHTML = '<tr><th>الكتاب</th><th>متاح؟</th><th>حذف</th></tr>';
  const snap = await getDocs(collection(db,'books'));
  snap.forEach(docSnap=>{
    const data = docSnap.data();
    const row = table.insertRow();
    row.insertCell().innerText = data.title;
    row.insertCell().innerText = data.available?'متاح':'غير متاح';
    const delBtn = document.createElement('button');
    delBtn.innerText = 'حذف';
    delBtn.onclick = ()=>deleteBook(docSnap.id);
    row.insertCell().appendChild(delBtn);
  });
}

// --- طلب الكتب ---
window.requestBook = async (bookId, bookTitle) => {
  if(!currentStudent) return;
  const btn = event.target;
  btn.innerHTML='<span class="loader"></span>';
  await addDoc(collection(db,'bookRequests'),{
    studentId: currentStudent.id,
    studentName: `${currentStudent.name} ${currentStudent.last}`,
    studentClass: currentStudent.sClass,
    bookId, bookTitle
  });
  renderBooks();
}

// --- الموافقة/الرفض ---
async function renderRequests() {
  const table = document.getElementById('requestsTable');
  table.innerHTML='<tr><th>اسم التلميذ</th><th>القسم</th><th>الكتاب</th><th>الموافقة</th><th>الرفض</th></tr>';
  const snap = await getDocs(collection(db,'bookRequests'));
  snap.forEach(docSnap=>{
    const data = docSnap.data();
    const row = table.insertRow();
    row.insertCell().innerText=data.studentName;
    row.insertCell().innerText=data.studentClass;
    row.insertCell().innerText=data.bookTitle;
    const approveBtn=document.createElement('button');
    approveBtn.innerText='موافقة';
    approveBtn.onclick=()=>approveBook(docSnap.id,data.bookId);
    row.insertCell().appendChild(approveBtn);
    const rejectBtn=document.createElement('button');
    rejectBtn.innerText='رفض';
    rejectBtn.onclick=()=>rejectBook(docSnap.id,data.studentId);
    row.insertCell().appendChild(rejectBtn);
  });
}

window.approveBook = async (requestId, bookId) => {
  const duration = prompt('ادخل مدة الاسترجاع بالأيام:');
  if(!duration) return;
  await updateDoc(doc(db,'books',bookId),{available:false});
  const reqSnap = await getDoc(doc(db,'bookRequests',requestId));
  const studentId = reqSnap.data().studentId;
  await addDoc(collection(db,'notifications'),{
    studentId,
    message:`تمت الموافقة على كتابك "${reqSnap.data().bookTitle}" لمدة ${duration} أيام`
  });
  await deleteDoc(doc(db,'bookRequests',requestId));
  renderRequests(); renderBooks();
}

window.rejectBook = async (requestId, studentId) => {
  const reqSnap = await getDoc(doc(db,'bookRequests',requestId));
  await addDoc(collection(db,'notifications'),{
    studentId,
    message:`تم رفض طلب كتاب "${reqSnap.data().bookTitle}" لأنه محجوز`
  });
  await deleteDoc(doc(db,'bookRequests',requestId));
  renderRequests();
}

// --- عرض الكتب للتلميذ ---
async function renderBooks() {
  const table = document.getElementById('booksTable');
  table.innerHTML='<tr><th>الكتاب</th><th>الحالة</th><th>طلب</th></tr>';
  const snap = await getDocs(collection(db,'books'));
  snap.forEach(docSnap=>{
    const data = docSnap.data();
    const row = table.insertRow();
    row.insertCell().innerText=data.title;
    row.insertCell().innerText=data.available?'متاح':'غير متاح';
    const btn = document.createElement('button');
    btn.innerText='طلب';
    btn.disabled=!data.available;
    btn.onclick=()=>requestBook(docSnap.id,data.title);
    row.insertCell().appendChild(btn);
  });
}

// --- إشعارات التلميذ ---
async function renderStudentMessages() {
  if(!currentStudent) return;
  const ul = document.getElementById('studentMessages');
  ul.innerHTML='';
  const snap = await getDocs(query(collection(db,'notifications'), where('studentId','==',currentStudent.id)));
  snap.forEach(docSnap=>{
    const li=document.createElement('li');
    li.innerText=docSnap.data().message;
    ul.appendChild(li);
  });
}

// --- الأخبار ---
async function addNews() {
  const news=document.getElementById('newsInput').value.trim();
  if(!news) return;
  await addDoc(collection(db,'news'),{text:news});
  document.getElementById('newsInput').value='';
  renderNews();
}

async function renderNews() {
  const snap = await getDocs(collection(db,'news'));
  let allNews='';
  snap.forEach(docSnap=>{ allNews+=docSnap.data().text+' --- '; });
  document.getElementById('newsContent').innerText=allNews;
}

renderNews();
</script>
</div>
</body>
</html>